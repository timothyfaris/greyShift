<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>greyShift - Color Cast Correction</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='greyShift_favicon.png') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .drag-drop-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 50px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .drag-drop-area.dragover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        .preview-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .single-image-view {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .view-header {
            text-align: center;
            width: 100%;
            max-width: 480px; /* Default for portrait, will be updated by JS */
        }

        .extra-large-thumbnail-container {
            position: relative;
            width: 100%;
            max-width: 480px; /* Default for portrait, will be updated by JS */
            min-height: 320px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            background: #fff;
        }
        .extra-large-thumbnail-container img, 
        .extra-large-thumbnail-container canvas {
            width: 100%;
            height: 100%;
            min-height: 320px;
            object-fit: contain;
            object-position: center;
            background: #f8f9fa;
            transition: opacity 0.3s ease;
            display: block;
        }
        .scalar-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .scalar-control .form-range {
            margin: 0;
        }

        .btn-group .btn {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
        @media (max-width: 768px) {
            .extra-large-thumbnail-container {
                max-width: 100%;
                min-height: 300px;
            }
            .extra-large-thumbnail-container img,
            .extra-large-thumbnail-container canvas {
                min-height: 240px;
            }
            .preview-controls {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            .scalar-control {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
                width: 100%;
            }
            .scalar-control .form-range {
                width: 100% !important;
            }
        }
        @media (max-width: 576px) {
            .preview-controls .btn-group {
                width: 100%;
            }
            .preview-controls .btn {
                flex: 1;
            }
        }
        .image-comparison {
            display: none;
        }
        .image-container {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .image-container img {
            width: 100%;
            height: auto;
            display: block;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .footer {
            margin-top: 50px;
            padding: 20px 0;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="{{ url_for('static', filename='greyShift_favicon.png') }}" alt="greyShift" height="30" class="me-1">
                greyShift
            </a>
            <!-- <span class="navbar-text">
                Automated Color Balance
            </span> -->
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-5">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <!-- Header -->
                <div class="text-center mb-4">
                    <h1>Automated, image-specific color balance</h1>
                    <p class="lead">Upload an image to automatically balance color. Fine-tune the correction intensity as needed.</p>
                </div>

                <!-- Upload Form -->
                <div class="card">
                    <div class="card-body">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <!-- File Upload -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Select Image</label>
                                <div class="drag-drop-area" id="dragDropArea">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <p class="mb-2">Drag & drop your image here, or click to select</p>
                                    <p class="text-muted small">Supports common image formats (currently optimized for web-sized images)</p>
                                    <input type="file" id="fileInput" name="file" accept="image/*" class="d-none">
                                </div>
                                <div id="fileInfo" class="mt-2 text-muted small" style="display: none;"></div>
                            </div>

                            <!-- Live Preview Section -->
                            <div class="mb-4" id="previewSection" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="preview-controls">
                                        <label class="form-label fw-bold mb-0">Color Correction Preview</label>
                                    </div>
                                    <div class="scalar-control">
                                        <label for="scalar" class="form-label fw-bold me-2">Correction Intensity:</label>
                                        <input type="range" class="form-range d-inline-block" id="scalar" name="scalar" 
                                               min="0.0" max="1.0" step="0.05" value="0.0" style="width: 200px;">
                                        <span id="scalarValue" class="badge bg-primary ms-2">0.00</span>
                                    </div>
                                </div>
                                <div class="preview-container">
                                    <div class="single-image-view">
                                        <div class="view-header mb-2">
                                            <h5 id="currentViewTitle" class="text-muted mb-0">
                                                <i class="fas fa-image me-2"></i><span id="titleText">Original Image</span>
                                            </h5>
                                                                        <small id="currentViewSubtitle" class="text-muted">Image processed automatically on upload. Move slider to preview different intensities.</small>
                                        </div>
                                        <div class="extra-large-thumbnail-container">
                                            <canvas id="previewCanvas"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="text-center">
                                <button type="submit" class="btn btn-primary btn-lg" id="processBtn" disabled>
                                    <i class="fas fa-redo me-2"></i>
                                    Reprocess with Current Settings
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Results -->
                <div class="image-comparison mt-5" id="resultsSection">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="mb-0">
                                <i class="fas fa-images me-2"></i>
                                Results
                            </h3>
                        </div>
                        <div class="card-body">
                            <!-- <div class="row">
                                <div class="col-md-6 mb-3">
                                    <h5>Original</h5>
                                    <div class="image-container">
                                        <img id="originalImage" src="" alt="Original Image">
                                    </div>
                                    <div class="mt-2 small text-muted" id="originalInfo"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <h5>Corrected</h5>
                                    <div class="image-container">
                                        <img id="processedImage" src="" alt="Processed Image">
                                    </div>
                                    <div class="mt-2 small text-muted" id="processedInfo"></div>
                                </div>
                            </div> -->
                            <div class="text-center mt-3">
                                <div class="mb-2">
                                    <span class="text-muted">Correction Intensity Applied: </span>
                                    <span id="downloadScalarValue" class="badge bg-success fs-6">0.00</span>
                                </div>
                                <a href="#" id="downloadBtn" class="btn btn-success btn-lg" download>
                                    <i class="fas fa-download me-2"></i>
                                    Download Corrected Image
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error Alert -->
                <div class="alert alert-danger d-none mt-3" id="errorAlert" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorMessage"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center text-white">
            <div class="spinner-border text-light" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-3">
                <h4>Processing Image...</h4>
                <p>This may take a few moments depending on image size</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container text-center text-muted">
            <p>&copy; 2025 greyShift. Built with Flask and Docker.</p>
            <p class="small">
                <i class="fas fa-info-circle me-1"></i>
                Original repository located at <a href="https://github.com/timothyfaris/processing-greyShift">https://github.com/timothyfaris/processing-greyShift</a>
            </p>
        </div>
    </footer>


    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dragDropArea = document.getElementById('dragDropArea');
            const fileInput = document.getElementById('fileInput');
            const fileInfo = document.getElementById('fileInfo');
            const uploadForm = document.getElementById('uploadForm');
            const processBtn = document.getElementById('processBtn');
            const scalarRange = document.getElementById('scalar');
            const scalarValue = document.getElementById('scalarValue');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const resultsSection = document.getElementById('resultsSection');
            const errorAlert = document.getElementById('errorAlert');

            // Global variables for preview
            let originalImageData = null;
            let previewCanvas = null;
            let previewCtx = null;
            let correctionOffsets = null;
            
            // Update scalar display and live preview
            scalarRange.addEventListener('input', function() {
                const value = parseFloat(this.value);
                const displayValue = value.toFixed(2);
                scalarValue.textContent = displayValue;
                
                // Always update preview canvas when slider changes
                if (originalImageData) {
                    updateLivePreview(value);
                }
                
                // Update title based on scalar value
                updateViewTitle(value);
            });

            // Drag and drop functionality
            dragDropArea.addEventListener('click', () => {
                hidePreview();
                fileInput.click();
            });
            
            dragDropArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });

            dragDropArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });

            dragDropArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    handleFileSelect();
                }
            });

            fileInput.addEventListener('change', handleFileSelect);

            function handleFileSelect() {
                const file = fileInput.files[0];
                if (file) {
                    // Validate file type
                    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/tiff', 'image/bmp', 'image/webp'];
                    if (!validTypes.includes(file.type)) {
                        hidePreview();
                        showError('Please select a valid image file (JPG, PNG, TIFF, BMP, WebP)');
                        return;
                    }
                    
                    // Validate file size (64MB = 64 * 1024 * 1024 bytes)
                    if (file.size > 64 * 1024 * 1024) {
                        hidePreview();
                        showError('File size must be less than 64MB');
                        return;
                    }
                    
                    const fileSize = (file.size / 1024 / 1024).toFixed(2);
                    
                    // Create preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const originalThumbnail = document.getElementById('originalThumbnail');
                        const previewSection = document.getElementById('previewSection');
                        
                        // Load original image
                        const tempImg = new Image();
                        tempImg.onload = function() {
                            // Display file info
                            fileInfo.innerHTML = `
                                <i class="fas fa-file-image me-1"></i>
                                Selected: <strong>${file.name}</strong> (${fileSize} MB) - ${tempImg.width}Ã—${tempImg.height} pixels
                            `;
                            fileInfo.style.display = 'block';
                            
                            // Set up canvas for live preview
                            setupPreviewCanvas(tempImg);
                            
                            // Analyze image for accurate correction offsets
                            analyzeImageForPreview(file);
                            
                            // Show preview section
                            previewSection.style.display = 'block';
                            previewSection.scrollIntoView({ behavior: 'smooth' });
                            
                            // Automatically process the image with default scalar value (0.2)
                            scalarRange.value = '0.2';
                            scalarValue.textContent = '0.20';
                            updateLivePreview(0.2);
                            updateViewTitle(0.2);
                            autoProcessImage();
                        };
                        tempImg.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                    
                    processBtn.disabled = false;
                    hideError();
                }
            }
            
            function setupPreviewCanvas(img) {
                previewCanvas = document.getElementById('previewCanvas');
                previewCtx = previewCanvas.getContext('2d');
                
                // Get container and header elements
                const container = document.querySelector('.extra-large-thumbnail-container');
                const header = document.querySelector('.view-header');
                
                // Determine orientation and set appropriate limits
                const imgRatio = img.width / img.height;
                let maxWidth, maxHeight, containerMaxWidth;
                
                if (img.height > img.width) {
                    // Portrait: 480x720
                    maxWidth = 480;
                    maxHeight = 720;
                    containerMaxWidth = 480;
                } else {
                    // Landscape or square: 720x480
                    maxWidth = 720;
                    maxHeight = 480;
                    containerMaxWidth = 720;
                }
                
                // Update container and header max-width dynamically
                container.style.maxWidth = containerMaxWidth + 'px';
                header.style.maxWidth = containerMaxWidth + 'px';
                
                // Calculate dimensions maintaining aspect ratio
                let canvasWidth, canvasHeight;
                
                if (imgRatio > (maxWidth / maxHeight)) {
                    // Limit by width
                    canvasWidth = Math.min(maxWidth, img.width);
                    canvasHeight = canvasWidth / imgRatio;
                } else {
                    // Limit by height
                    canvasHeight = Math.min(maxHeight, img.height);
                    canvasWidth = canvasHeight * imgRatio;
                }
                
                // Set canvas dimensions
                previewCanvas.width = canvasWidth;
                previewCanvas.height = canvasHeight;
                previewCanvas.style.width = '100%';
                previewCanvas.style.height = '100%';
                previewCanvas.style.objectFit = 'contain';
                previewCanvas.style.objectPosition = 'center';
                
                // Draw the original image and get image data
                previewCtx.drawImage(img, 0, 0, canvasWidth, canvasHeight);
                originalImageData = previewCtx.getImageData(0, 0, canvasWidth, canvasHeight);
                
                // Generate initial preview (starts with scalar 0 = original)
                updateLivePreview(parseFloat(scalarRange.value));
                updateViewTitle(parseFloat(scalarRange.value));
            }
            

            
            function updateViewTitle(scalar) {
                const titleText = document.getElementById('titleText');
                const titleIcon = document.querySelector('#currentViewTitle i');
                
                if (scalar === 0) {
                    titleText.textContent = 'Original Image';
                    titleIcon.className = 'fas fa-image me-2';
                } else {
                    titleText.textContent = `Color Corrected (${(scalar * 100).toFixed(0)}%)`;
                    titleIcon.className = 'fas fa-magic me-2';
                }
            }
            
            function analyzeImageForPreview(file) {
                // Send the ORIGINAL full-resolution image to server for analysis
                // This ensures preview and processed image use the SAME correction offsets
                const formData = new FormData();
                formData.append('file', file);
                
                fetch('/analyze', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    // Check if response is JSON before parsing
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        console.warn('Analysis returned non-JSON response, using fallback preview');
                        throw new TypeError('Response is not JSON');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        correctionOffsets = {
                            red: data.red_avg_offset,
                            green: data.green_avg_offset,
                            blue: data.blue_avg_offset
                        };
                        
                        // Update preview with actual offsets from full-res analysis
                        updateLivePreview(parseFloat(scalarRange.value));
                    } else {
                        console.error('Analysis failed:', data.error);
                        // Fall back to simplified preview if analysis fails
                        correctionOffsets = null;
                        updateLivePreview(parseFloat(scalarRange.value));
                    }
                })
                .catch(error => {
                    console.warn('Analysis unavailable, using simplified preview:', error.message);
                    // Fall back to simplified preview if network error
                    correctionOffsets = null;
                    updateLivePreview(parseFloat(scalarRange.value));
                });
            }
            

            
            function updateLivePreview(scalar) {
                if (!originalImageData || !previewCtx) return;
                
                // Clone the original image data
                const imageData = previewCtx.createImageData(originalImageData);
                const data = imageData.data;
                const originalData = originalImageData.data;
                
                if (correctionOffsets) {
                    // Use actual greyShift algorithm with real correction offsets
                    for (let i = 0; i < data.length; i += 4) {
                        const r = originalData[i];
                        const g = originalData[i + 1];
                        const b = originalData[i + 2];
                        const a = originalData[i + 3];
                        
                        // Apply the exact same correction as the server-side algorithm
                        const rCorrection = correctionOffsets.red * scalar;
                        const gCorrection = correctionOffsets.green * scalar;
                        const bCorrection = correctionOffsets.blue * scalar;
                        
                        // Apply corrections with clamping (same as greyshift.py)
                        data[i] = Math.max(0, Math.min(255, Math.round(r - rCorrection)));     // Red
                        data[i + 1] = Math.max(0, Math.min(255, Math.round(g - gCorrection))); // Green
                        data[i + 2] = Math.max(0, Math.min(255, Math.round(b - bCorrection))); // Blue
                        data[i + 3] = a; // Alpha unchanged
                    }
                } else {
                    // Fallback: use simplified simulation if analysis hasn't completed yet
                    for (let i = 0; i < data.length; i += 4) {
                        const r = originalData[i];
                        const g = originalData[i + 1];
                        const b = originalData[i + 2];
                        const a = originalData[i + 3];
                        
                        // Simple fallback correction
                        const rCorrection = scalar * 5;
                        const gCorrection = scalar * 2;
                        const bCorrection = scalar * -3;
                        
                        data[i] = Math.max(0, Math.min(255, r - rCorrection));
                        data[i + 1] = Math.max(0, Math.min(255, g - gCorrection));
                        data[i + 2] = Math.max(0, Math.min(255, b - bCorrection));
                        data[i + 3] = a;
                    }
                }
                
                // Draw the processed image
                previewCtx.putImageData(imageData, 0, 0);
            }

            // Form submission
            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (!fileInput.files[0]) {
                    showError('Please select an image file');
                    return;
                }

                const formData = new FormData(this);
                
                loadingOverlay.style.display = 'flex';
                hideError();
                
                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    // Check if response is JSON before parsing
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new TypeError('Server returned non-JSON response. Please check server logs.');
                    }
                    return response.json();
                })
                .then(data => {
                    loadingOverlay.style.display = 'none';
                    
                    if (data.success) {
                        showResults(data);
                    } else {
                        showError(data.error || 'Processing failed');
                    }
                })
                .catch(error => {
                    loadingOverlay.style.display = 'none';
                    showError('Network error: ' + error.message);
                });
            });

            function showResults(data) {
                console.log('Showing results with data:', data);
                
                const downloadBtn = document.getElementById('downloadBtn');
                const downloadScalarValue = document.getElementById('downloadScalarValue');
                
                // Set download link
                downloadBtn.href = data.download_url;
                
                // Update scalar verification display
                downloadScalarValue.textContent = parseFloat(data.scalar).toFixed(2);
                
                console.log('Download URL set to:', data.download_url);
                
                resultsSection.style.display = 'block';
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }

            function showError(message) {
                document.getElementById('errorMessage').textContent = message;
                errorAlert.classList.remove('d-none');
                errorAlert.scrollIntoView({ behavior: 'smooth' });
            }

            function hideError() {
                errorAlert.classList.add('d-none');
            }
            
            function hidePreview() {
                document.getElementById('previewSection').style.display = 'none';
                fileInfo.style.display = 'none';
                processBtn.disabled = true;
                originalImageData = null;
                previewCanvas = null;
                previewCtx = null;
            }
            
            function autoProcessImage() {
                // Automatically process the image with the current scalar value
                if (!fileInput.files[0]) return;
                
                const formData = new FormData(uploadForm);
                
                loadingOverlay.style.display = 'flex';
                hideError();
                
                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    // Check if response is JSON before parsing
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        // Log the actual response for debugging
                        return response.text().then(text => {
                            console.error('Non-JSON response received:', text.substring(0, 500));
                            throw new TypeError('Server error - check server logs. Response: ' + text.substring(0, 100));
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    loadingOverlay.style.display = 'none';
                    
                    if (data.success) {
                        showResults(data);
                    } else {
                        showError(data.error || 'Auto-processing failed');
                    }
                })
                .catch(error => {
                    loadingOverlay.style.display = 'none';
                    console.error('Auto-processing error details:', error);
                    showError('Auto-processing error: ' + error.message);
                });
            }
        });
    </script>
</body>
</html>